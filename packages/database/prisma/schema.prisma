// Verified Care - Database Schema
// NDIS Provider Marketplace Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserType {
  participant
  coordinator
  provider
  admin
}

enum UserStatus {
  pending
  active
  suspended
  deactivated
}

enum AustralianState {
  VIC
  NSW
  QLD
  SA
  WA
  NT
  TAS
  ACT
}

enum PlanManagementType {
  self
  plan
  agency
}

enum BusinessType {
  sole_trader
  company
  partnership
  trust
}

enum ComplianceStatus {
  pending
  verified
  expired
  suspended
}

enum DocumentType {
  public_liability_insurance
  professional_indemnity_insurance
  workers_compensation
  ndis_worker_screening
  wwcc
  police_check
  first_aid_certificate
  covid_vaccination
  ahpra_registration
  drivers_license
  vehicle_registration
  vehicle_insurance
  abn_certificate
  other
}

enum VerificationStatus {
  pending
  verified
  rejected
  expired
}

enum ServiceType {
  domestic_cleaning
  community_transport
  yard_maintenance
}

enum PricingType {
  hourly
  fixed
  quoted
}

enum BookingStatus {
  pending
  accepted
  declined
  cancelled
  in_progress
  pending_confirmation
  completed
  disputed
  invoiced
}

enum CheckType {
  check_in
  check_out
}

enum InvoiceStatus {
  draft
  sent
  viewed
  paid
  partially_paid
  overdue
  cancelled
  disputed
}

enum PayoutStatus {
  pending
  processing
  paid
  failed
}

enum DisputeType {
  service_not_delivered
  service_incomplete
  quality_issue
  wrong_charge
  overcharge
  no_show_provider
  no_show_participant
  property_damage
  misconduct
  other
}

enum DisputeStatus {
  open
  under_review
  awaiting_response
  mediation
  resolved
  escalated
  closed
}

enum IncidentType {
  abuse_neglect
  injury
  medication_error
  missing_person
  restrictive_practice
  property_damage
  complaint
  other
}

enum IncidentSeverity {
  low
  medium
  high
  critical
}

enum IncidentStatus {
  reported
  under_investigation
  action_required
  resolved
  closed
  reported_to_commission
}

// ============================================
// USER TABLES
// ============================================

model User {
  id                     String      @id @default(uuid()) @db.Uuid
  email                  String      @unique @db.VarChar(255)
  phone                  String?     @db.VarChar(20)
  passwordHash           String      @map("password_hash") @db.VarChar(255)

  // Profile
  firstName              String      @map("first_name") @db.VarChar(100)
  lastName               String      @map("last_name") @db.VarChar(100)
  preferredName          String?     @map("preferred_name") @db.VarChar(100)
  dateOfBirth            DateTime?   @map("date_of_birth") @db.Date
  avatarUrl              String?     @map("avatar_url") @db.VarChar(500)

  // Role & Status
  userType               UserType    @map("user_type")
  status                 UserStatus  @default(pending)

  // Verification
  emailVerifiedAt        DateTime?   @map("email_verified_at")
  phoneVerifiedAt        DateTime?   @map("phone_verified_at")
  identityVerifiedAt     DateTime?   @map("identity_verified_at")

  // Location
  addressLine1           String?     @map("address_line_1") @db.VarChar(255)
  addressLine2           String?     @map("address_line_2") @db.VarChar(255)
  suburb                 String?     @db.VarChar(100)
  state                  AustralianState?
  postcode               String?     @db.VarChar(10)
  latitude               Decimal?    @db.Decimal(10, 8)
  longitude              Decimal?    @db.Decimal(11, 8)

  // Preferences
  notificationPreferences Json?      @default("{\"email\": true, \"sms\": true, \"push\": true}") @map("notification_preferences")
  accessibilityPreferences Json?     @default("{}") @map("accessibility_preferences")
  timezone               String      @default("Australia/Sydney") @db.VarChar(50)

  // Password Reset
  passwordResetToken     String?     @map("password_reset_token") @db.VarChar(255)
  passwordResetExpires   DateTime?   @map("password_reset_expires")

  // Metadata
  lastLoginAt            DateTime?   @map("last_login_at")
  createdAt              DateTime    @default(now()) @map("created_at")
  updatedAt              DateTime    @updatedAt @map("updated_at")
  deletedAt              DateTime?   @map("deleted_at")

  // Relations
  participant            Participant?
  coordinator            Coordinator?
  provider               Provider?

  // Audit
  auditLogs              AuditLog[]
  notifications          Notification[]
  sentMessages           Message[]   @relation("SentMessages")

  @@index([email])
  @@index([userType, status])
  @@index([state, postcode])
  @@map("users")
}

model Participant {
  id                       String              @id @default(uuid()) @db.Uuid
  userId                   String              @unique @map("user_id") @db.Uuid
  user                     User                @relation(fields: [userId], references: [id])

  // NDIS Details
  ndisNumber               String?             @unique @map("ndis_number") @db.VarChar(20)
  ndisPlanStartDate        DateTime?           @map("ndis_plan_start_date") @db.Date
  ndisPlanEndDate          DateTime?           @map("ndis_plan_end_date") @db.Date
  planManagementType       PlanManagementType? @map("plan_management_type")

  // Plan Manager
  planManagerId            String?             @map("plan_manager_id") @db.Uuid
  planManager              PlanManager?        @relation(fields: [planManagerId], references: [id])

  // Support Coordinator
  primaryCoordinatorId     String?             @map("primary_coordinator_id") @db.Uuid
  primaryCoordinator       Coordinator?        @relation(fields: [primaryCoordinatorId], references: [id])

  // Emergency Contact
  emergencyContactName     String?             @map("emergency_contact_name") @db.VarChar(200)
  emergencyContactPhone    String?             @map("emergency_contact_phone") @db.VarChar(20)
  emergencyContactRelation String?             @map("emergency_contact_relationship") @db.VarChar(50)

  // Care Needs
  serviceNeeds             Json                @default("[]") @map("service_needs")
  communicationNeeds       Json                @default("{}") @map("communication_needs")
  mobilityRequirements     String?             @map("mobility_requirements")
  specialInstructions      String?             @map("special_instructions")

  // Consent & Preferences
  allowsCoordinatorBooking Boolean             @default(true) @map("allows_coordinator_booking")
  allowsFamilyAccess       Boolean             @default(false) @map("allows_family_access")
  photoConsent             Boolean             @default(false) @map("photo_consent")

  createdAt                DateTime            @default(now()) @map("created_at")
  updatedAt                DateTime            @updatedAt @map("updated_at")

  // Relations
  bookings                 Booking[]
  invoices                 Invoice[]

  @@index([ndisNumber])
  @@index([primaryCoordinatorId])
  @@map("participants")
}

model Coordinator {
  id                       String              @id @default(uuid()) @db.Uuid
  userId                   String              @unique @map("user_id") @db.Uuid
  user                     User                @relation(fields: [userId], references: [id])

  // Business Details
  organisationName         String?             @map("organisation_name") @db.VarChar(255)
  abn                      String?             @db.VarChar(14)
  ndisRegistrationNumber   String?             @map("ndis_registration_number") @db.VarChar(50)
  isRegisteredProvider     Boolean             @default(false) @map("is_registered_provider")

  // Verification
  registrationVerifiedAt   DateTime?           @map("registration_verified_at")
  abnVerifiedAt            DateTime?           @map("abn_verified_at")

  // Conflict of Interest Tracking
  affiliatedProviderIds    String[]            @default([]) @map("affiliated_provider_ids") @db.Uuid
  conflictDisclosureText   String?             @map("conflict_disclosure_text")
  conflictAcknowledgedAt   DateTime?           @map("conflict_acknowledged_at")

  // Service Area
  serviceStates            AustralianState[]   @map("service_states")
  servicePostcodes         String[]            @default([]) @map("service_postcodes")

  // Stats
  activeParticipantCount   Int                 @default(0) @map("active_participant_count")
  totalBookingsMade        Int                 @default(0) @map("total_bookings_made")

  createdAt                DateTime            @default(now()) @map("created_at")
  updatedAt                DateTime            @updatedAt @map("updated_at")

  // Relations
  participants             Participant[]
  bookingsCreated          Booking[]           @relation("CoordinatorBookings")

  @@index([abn])
  @@index([organisationName])
  @@map("coordinators")
}

model Provider {
  id                       String              @id @default(uuid()) @db.Uuid
  userId                   String              @unique @map("user_id") @db.Uuid
  user                     User                @relation(fields: [userId], references: [id])

  // Business Details
  businessName             String              @map("business_name") @db.VarChar(255)
  abn                      String              @db.VarChar(14)
  acn                      String?             @db.VarChar(12)
  businessType             BusinessType?       @map("business_type")

  // NDIS Registration
  ndisRegistrationNumber   String?             @map("ndis_registration_number") @db.VarChar(50)
  isNdisRegistered         Boolean             @default(false) @map("is_ndis_registered")
  registrationGroups       Int[]               @default([]) @map("registration_groups")

  // Verification
  abnVerifiedAt            DateTime?           @map("abn_verified_at")
  abnStatus                String?             @map("abn_status") @db.VarChar(20)
  gstRegistered            Boolean             @default(false) @map("gst_registered")

  // Compliance
  complianceStatus         ComplianceStatus    @default(pending) @map("compliance_status")
  complianceVerifiedAt     DateTime?           @map("compliance_verified_at")
  complianceExpiresAt      DateTime?           @map("compliance_expires_at")

  // Services
  serviceTypes             ServiceType[]       @map("service_types")

  // Service Area
  serviceRadiusKm          Int                 @default(25) @map("service_radius_km")
  serviceStates            AustralianState[]   @map("service_states")
  servicePostcodes         String[]            @default([]) @map("service_postcodes")
  travelsToClient          Boolean             @default(true) @map("travels_to_client")

  // Pricing
  pricingStrategy          PricingType         @default(fixed) @map("pricing_strategy")

  // Banking
  bankAccountName          String?             @map("bank_account_name") @db.VarChar(255)
  bankBsb                  String?             @map("bank_bsb") @db.VarChar(10)
  bankAccountNumberEncrypted String?           @map("bank_account_number_encrypted") @db.VarChar(255)
  stripeConnectId          String?             @map("stripe_connect_id") @db.VarChar(100)

  // Profile
  bio                      String?
  yearsExperience          Int?                @map("years_experience")
  languagesSpoken          String[]            @default(["English"]) @map("languages_spoken")

  // Stats
  averageRating            Decimal             @default(0) @map("average_rating") @db.Decimal(3, 2)
  totalReviews             Int                 @default(0) @map("total_reviews")
  totalCompletedBookings   Int                 @default(0) @map("total_completed_bookings")
  responseRate             Decimal             @default(0) @map("response_rate") @db.Decimal(5, 2)
  averageResponseTimeHours Decimal?            @map("average_response_time_hours") @db.Decimal(5, 2)

  // Fair Price Score
  fairPriceScore           Decimal?            @map("fair_price_score") @db.Decimal(3, 2)
  fairPriceScoreUpdatedAt  DateTime?           @map("fair_price_score_updated_at")

  createdAt                DateTime            @default(now()) @map("created_at")
  updatedAt                DateTime            @updatedAt @map("updated_at")

  // Relations
  documents                ProviderDocument[]
  services                 ProviderService[]
  bookings                 Booking[]
  invoices                 Invoice[]
  payouts                  ProviderPayout[]

  @@index([abn])
  @@index([complianceStatus])
  @@index([averageRating(sort: Desc)])
  @@map("providers")
}

// ============================================
// PROVIDER COMPLIANCE
// ============================================

model ProviderDocument {
  id                   String             @id @default(uuid()) @db.Uuid
  providerId           String             @map("provider_id") @db.Uuid
  provider             Provider           @relation(fields: [providerId], references: [id])

  documentType         DocumentType       @map("document_type")
  documentNumber       String?            @map("document_number") @db.VarChar(100)
  issuingAuthority     String?            @map("issuing_authority") @db.VarChar(255)
  issuedDate           DateTime?          @map("issued_date") @db.Date
  expiryDate           DateTime?          @map("expiry_date") @db.Date

  // File
  fileUrl              String             @map("file_url") @db.VarChar(500)
  fileName             String?            @map("file_name") @db.VarChar(255)
  fileSizeBytes        Int?               @map("file_size_bytes")
  fileMimeType         String?            @map("file_mime_type") @db.VarChar(100)

  // Verification
  verificationStatus   VerificationStatus @default(pending) @map("verification_status")
  verifiedBy           String?            @map("verified_by") @db.Uuid
  verifiedAt           DateTime?          @map("verified_at")
  rejectionReason      String?            @map("rejection_reason")

  // OCR Data
  extractedData        Json               @default("{}") @map("extracted_data")

  // Notifications
  expiryNotified30Days Boolean            @default(false) @map("expiry_notified_30_days")
  expiryNotified7Days  Boolean            @default(false) @map("expiry_notified_7_days")

  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  @@index([providerId])
  @@index([documentType])
  @@index([expiryDate])
  @@index([verificationStatus])
  @@map("provider_documents")
}

// ============================================
// SERVICES & PRICING
// ============================================

model NdisSupportCategory {
  id             String            @id @default(uuid()) @db.Uuid
  categoryNumber Int               @unique @map("category_number")
  categoryName   String            @map("category_name") @db.VarChar(255)
  description    String?

  createdAt      DateTime          @default(now()) @map("created_at")

  supportItems   NdisSupportItem[]

  @@map("ndis_support_categories")
}

model NdisSupportItem {
  id                       String               @id @default(uuid()) @db.Uuid
  categoryId               String               @map("category_id") @db.Uuid
  category                 NdisSupportCategory  @relation(fields: [categoryId], references: [id])

  itemNumber               String               @unique @map("item_number") @db.VarChar(20)
  itemName                 String               @map("item_name") @db.VarChar(500)
  description              String?

  registrationGroupNumber  Int?                 @map("registration_group_number")
  registrationGroupName    String?              @map("registration_group_name") @db.VarChar(255)
  requiresQuote            Boolean              @default(false) @map("requires_quote")

  unit                     String               @db.VarChar(20)

  agencyManaged            Boolean              @default(true) @map("agency_managed")
  planManaged              Boolean              @default(true) @map("plan_managed")
  selfManaged              Boolean              @default(true) @map("self_managed")

  isActive                 Boolean              @default(true) @map("is_active")
  effectiveFrom            DateTime?            @map("effective_from") @db.Date
  effectiveTo              DateTime?            @map("effective_to") @db.Date

  createdAt                DateTime             @default(now()) @map("created_at")
  updatedAt                DateTime             @updatedAt @map("updated_at")

  priceLimits              NdisPriceLimit[]
  providerServices         ProviderService[]
  bookings                 Booking[]

  @@index([itemNumber])
  @@index([categoryId])
  @@map("ndis_support_items")
}

model NdisPriceLimit {
  id                 String           @id @default(uuid()) @db.Uuid
  supportItemId      String           @map("support_item_id") @db.Uuid
  supportItem        NdisSupportItem  @relation(fields: [supportItemId], references: [id])

  state              AustralianState?
  isRemote           Boolean          @default(false) @map("is_remote")
  isVeryRemote       Boolean          @default(false) @map("is_very_remote")

  weekdayRate        Decimal?         @map("weekday_rate") @db.Decimal(10, 2)
  weekdayEveningRate Decimal?         @map("weekday_evening_rate") @db.Decimal(10, 2)
  saturdayRate       Decimal?         @map("saturday_rate") @db.Decimal(10, 2)
  sundayRate         Decimal?         @map("sunday_rate") @db.Decimal(10, 2)
  publicHolidayRate  Decimal?         @map("public_holiday_rate") @db.Decimal(10, 2)

  standardRate       Decimal?         @map("standard_rate") @db.Decimal(10, 2)

  effectiveFrom      DateTime         @map("effective_from") @db.Date
  effectiveTo        DateTime?        @map("effective_to") @db.Date

  priceGuideVersion  String?          @map("price_guide_version") @db.VarChar(50)

  createdAt          DateTime         @default(now()) @map("created_at")

  @@index([supportItemId])
  @@index([state])
  @@index([effectiveFrom, effectiveTo])
  @@map("ndis_price_limits")
}

model ProviderService {
  id                   String           @id @default(uuid()) @db.Uuid
  providerId           String           @map("provider_id") @db.Uuid
  provider             Provider         @relation(fields: [providerId], references: [id])

  serviceType          ServiceType      @map("service_type")
  ndisSupportItemId    String?          @map("ndis_support_item_id") @db.Uuid
  ndisSupportItem      NdisSupportItem? @relation(fields: [ndisSupportItemId], references: [id])

  serviceName          String           @map("service_name") @db.VarChar(255)
  description          String?

  pricingType          PricingType      @map("pricing_type")
  baseRate             Decimal?         @map("base_rate") @db.Decimal(10, 2)
  minimumBookingHours  Decimal          @default(1) @map("minimum_booking_hours") @db.Decimal(4, 2)

  weekdayRate          Decimal?         @map("weekday_rate") @db.Decimal(10, 2)
  eveningRate          Decimal?         @map("evening_rate") @db.Decimal(10, 2)
  saturdayRate         Decimal?         @map("saturday_rate") @db.Decimal(10, 2)
  sundayRate           Decimal?         @map("sunday_rate") @db.Decimal(10, 2)
  publicHolidayRate    Decimal?         @map("public_holiday_rate") @db.Decimal(10, 2)

  inclusions           String[]         @default([])
  exclusions           String[]         @default([])

  isActive             Boolean          @default(true) @map("is_active")
  availableDays        Int[]            @default([1, 2, 3, 4, 5]) @map("available_days")
  availableStartTime   DateTime?        @map("available_start_time") @db.Time()
  availableEndTime     DateTime?        @map("available_end_time") @db.Time()

  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  bookings             Booking[]

  @@unique([providerId, serviceType, ndisSupportItemId])
  @@index([providerId])
  @@index([serviceType])
  @@index([isActive])
  @@map("provider_services")
}

// ============================================
// BOOKINGS
// ============================================

model Booking {
  id                       String           @id @default(uuid()) @db.Uuid
  bookingNumber            String           @unique @map("booking_number") @db.VarChar(20)

  // Parties
  participantId            String           @map("participant_id") @db.Uuid
  participant              Participant      @relation(fields: [participantId], references: [id])
  providerId               String           @map("provider_id") @db.Uuid
  provider                 Provider         @relation(fields: [providerId], references: [id])
  providerServiceId        String           @map("provider_service_id") @db.Uuid
  providerService          ProviderService  @relation(fields: [providerServiceId], references: [id])

  // Creator
  createdByUserId          String           @map("created_by_user_id") @db.Uuid
  createdByRole            String           @map("created_by_role") @db.VarChar(20)
  coordinatorId            String?          @map("coordinator_id") @db.Uuid
  coordinator              Coordinator?     @relation("CoordinatorBookings", fields: [coordinatorId], references: [id])

  // Service Details
  serviceType              ServiceType      @map("service_type")
  ndisSupportItemId        String?          @map("ndis_support_item_id") @db.Uuid
  ndisSupportItem          NdisSupportItem? @relation(fields: [ndisSupportItemId], references: [id])
  ndisItemNumber           String?          @map("ndis_item_number") @db.VarChar(20)

  // Scheduling
  scheduledDate            DateTime         @map("scheduled_date") @db.Date
  scheduledStartTime       DateTime         @map("scheduled_start_time") @db.Time()
  scheduledEndTime         DateTime         @map("scheduled_end_time") @db.Time()
  scheduledDurationHours   Decimal          @map("scheduled_duration_hours") @db.Decimal(5, 2)
  timezone                 String           @default("Australia/Sydney") @db.VarChar(50)

  // Location
  serviceAddressLine1      String?          @map("service_address_line_1") @db.VarChar(255)
  serviceAddressLine2      String?          @map("service_address_line_2") @db.VarChar(255)
  serviceSuburb            String?          @map("service_suburb") @db.VarChar(100)
  serviceState             AustralianState? @map("service_state")
  servicePostcode          String?          @map("service_postcode") @db.VarChar(10)
  serviceLatitude          Decimal?         @map("service_latitude") @db.Decimal(10, 8)
  serviceLongitude         Decimal?         @map("service_longitude") @db.Decimal(11, 8)

  // Pricing
  quotedRate               Decimal          @map("quoted_rate") @db.Decimal(10, 2)
  rateType                 PricingType?     @map("rate_type")
  ndisPriceCap             Decimal?         @map("ndis_price_cap") @db.Decimal(10, 2)
  isWithinNdisCap          Boolean          @default(true) @map("is_within_ndis_cap")
  estimatedTotal           Decimal          @map("estimated_total") @db.Decimal(10, 2)

  // Status
  status                   BookingStatus    @default(pending)

  // Provider Response
  providerResponseAt       DateTime?        @map("provider_response_at")
  providerResponseDeadline DateTime?        @map("provider_response_deadline")
  declineReason            String?          @map("decline_reason")

  // Actual Delivery
  actualStartTime          DateTime?        @map("actual_start_time")
  actualEndTime            DateTime?        @map("actual_end_time")
  actualDurationHours      Decimal?         @map("actual_duration_hours") @db.Decimal(5, 2)

  // Dual Confirmation
  providerConfirmedAt      DateTime?        @map("provider_confirmed_at")
  providerConfirmedBy      String?          @map("provider_confirmed_by") @db.Uuid
  participantConfirmedAt   DateTime?        @map("participant_confirmed_at")
  participantConfirmedBy   String?          @map("participant_confirmed_by") @db.Uuid
  autoConfirmedAt          DateTime?        @map("auto_confirmed_at")
  confirmationDeadline     DateTime?        @map("confirmation_deadline")

  // Notes
  participantNotes         String?          @map("participant_notes")
  providerNotes            String?          @map("provider_notes")
  internalNotes            String?          @map("internal_notes")

  // Cancellation
  cancelledAt              DateTime?        @map("cancelled_at")
  cancelledBy              String?          @map("cancelled_by") @db.Uuid
  cancellationReason       String?          @map("cancellation_reason")
  cancellationFee          Decimal          @default(0) @map("cancellation_fee") @db.Decimal(10, 2)

  // Metadata
  source                   String           @default("web") @db.VarChar(20)

  createdAt                DateTime         @default(now()) @map("created_at")
  updatedAt                DateTime         @updatedAt @map("updated_at")

  // Relations
  statusHistory            BookingStatusHistory[]
  checkIns                 BookingCheckIn[]
  review                   Review?
  dispute                  Dispute?
  invoiceLineItems         InvoiceLineItem[]

  @@index([bookingNumber])
  @@index([participantId])
  @@index([providerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([coordinatorId])
  @@map("bookings")
}

model BookingStatusHistory {
  id           String   @id @default(uuid()) @db.Uuid
  bookingId    String   @map("booking_id") @db.Uuid
  booking      Booking  @relation(fields: [bookingId], references: [id])

  fromStatus   String?  @map("from_status") @db.VarChar(30)
  toStatus     String   @map("to_status") @db.VarChar(30)

  changedBy    String?  @map("changed_by") @db.Uuid
  changedByRole String? @map("changed_by_role") @db.VarChar(20)
  reason       String?

  metadata     Json     @default("{}")

  createdAt    DateTime @default(now()) @map("created_at")

  @@index([bookingId])
  @@map("booking_status_history")
}

model BookingCheckIn {
  id                              String    @id @default(uuid()) @db.Uuid
  bookingId                       String    @map("booking_id") @db.Uuid
  booking                         Booking   @relation(fields: [bookingId], references: [id])
  userId                          String    @map("user_id") @db.Uuid

  checkType                       CheckType @map("check_type")

  latitude                        Decimal   @db.Decimal(10, 8)
  longitude                       Decimal   @db.Decimal(11, 8)
  accuracyMeters                  Decimal?  @map("accuracy_meters") @db.Decimal(10, 2)

  isWithinGeofence                Boolean?  @map("is_within_geofence")
  distanceFromServiceLocationMeters Decimal? @map("distance_from_service_location_meters") @db.Decimal(10, 2)

  photoUrl                        String?   @map("photo_url") @db.VarChar(500)
  deviceInfo                      Json?     @map("device_info")
  ipAddress                       String?   @map("ip_address") @db.Inet

  createdAt                       DateTime  @default(now()) @map("created_at")

  @@index([bookingId])
  @@map("booking_check_ins")
}

// ============================================
// INVOICING & PAYMENTS
// ============================================

model PlanManager {
  id                         String        @id @default(uuid()) @db.Uuid

  organisationName           String        @map("organisation_name") @db.VarChar(255)
  abn                        String        @db.VarChar(14)

  email                      String        @db.VarChar(255)
  phone                      String?       @db.VarChar(20)

  addressLine1               String?       @map("address_line_1") @db.VarChar(255)
  suburb                     String?       @db.VarChar(100)
  state                      AustralianState?
  postcode                   String?       @db.VarChar(10)

  acceptsElectronicInvoices  Boolean       @default(false) @map("accepts_electronic_invoices")
  invoiceEmail               String?       @map("invoice_email") @db.VarChar(255)
  apiEndpoint                String?       @map("api_endpoint") @db.VarChar(500)
  apiKeyEncrypted            String?       @map("api_key_encrypted") @db.VarChar(255)

  participantCount           Int           @default(0) @map("participant_count")
  averagePaymentDays         Decimal?      @map("average_payment_days") @db.Decimal(5, 2)

  isActive                   Boolean       @default(true) @map("is_active")
  createdAt                  DateTime      @default(now()) @map("created_at")
  updatedAt                  DateTime      @updatedAt @map("updated_at")

  participants               Participant[]
  invoices                   Invoice[]

  @@index([abn])
  @@map("plan_managers")
}

model Invoice {
  id                 String        @id @default(uuid()) @db.Uuid
  invoiceNumber      String        @unique @map("invoice_number") @db.VarChar(30)

  // Parties
  providerId         String        @map("provider_id") @db.Uuid
  provider           Provider      @relation(fields: [providerId], references: [id])
  participantId      String        @map("participant_id") @db.Uuid
  participant        Participant   @relation(fields: [participantId], references: [id])

  // Billing
  billToType         String        @map("bill_to_type") @db.VarChar(20)
  planManagerId      String?       @map("plan_manager_id") @db.Uuid
  planManager        PlanManager?  @relation(fields: [planManagerId], references: [id])

  // Dates
  invoiceDate        DateTime      @default(now()) @map("invoice_date") @db.Date
  dueDate            DateTime      @map("due_date") @db.Date

  // Amounts
  subtotal           Decimal       @db.Decimal(12, 2)
  gstAmount          Decimal       @default(0) @map("gst_amount") @db.Decimal(12, 2)
  platformFee        Decimal       @map("platform_fee") @db.Decimal(12, 2)
  platformFeeGst     Decimal       @default(0) @map("platform_fee_gst") @db.Decimal(12, 2)
  totalAmount        Decimal       @map("total_amount") @db.Decimal(12, 2)
  providerPayout     Decimal       @map("provider_payout") @db.Decimal(12, 2)

  // Status
  status             InvoiceStatus @default(draft)

  // Payment
  amountPaid         Decimal       @default(0) @map("amount_paid") @db.Decimal(12, 2)
  paidAt             DateTime?     @map("paid_at")
  paymentMethod      String?       @map("payment_method") @db.VarChar(50)

  // Payout
  payoutStatus       PayoutStatus  @default(pending) @map("payout_status")
  payoutAt           DateTime?     @map("payout_at")
  stripeTransferId   String?       @map("stripe_transfer_id") @db.VarChar(100)

  // NDIS
  ndisClaimReference String?       @map("ndis_claim_reference") @db.VarChar(50)

  // PDF
  pdfUrl             String?       @map("pdf_url") @db.VarChar(500)
  pdfGeneratedAt     DateTime?     @map("pdf_generated_at")

  // Notes
  notes              String?
  internalNotes      String?       @map("internal_notes")

  sentAt             DateTime?     @map("sent_at")
  viewedAt           DateTime?     @map("viewed_at")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  lineItems          InvoiceLineItem[]
  payments           Payment[]

  @@index([invoiceNumber])
  @@index([providerId])
  @@index([participantId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model InvoiceLineItem {
  id                 String           @id @default(uuid()) @db.Uuid
  invoiceId          String           @map("invoice_id") @db.Uuid
  invoice            Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  bookingId          String?          @map("booking_id") @db.Uuid
  booking            Booking?         @relation(fields: [bookingId], references: [id])

  lineNumber         Int              @map("line_number")
  description        String           @db.VarChar(500)

  ndisSupportItemId  String?          @map("ndis_support_item_id") @db.Uuid
  ndisItemNumber     String?          @map("ndis_item_number") @db.VarChar(20)
  ndisItemName       String?          @map("ndis_item_name") @db.VarChar(255)

  serviceDate        DateTime         @map("service_date") @db.Date
  serviceStartTime   DateTime?        @map("service_start_time") @db.Time()
  serviceEndTime     DateTime?        @map("service_end_time") @db.Time()

  quantity           Decimal          @db.Decimal(10, 2)
  unit               String           @db.VarChar(20)
  unitRate           Decimal          @map("unit_rate") @db.Decimal(10, 2)
  ndisPriceCap       Decimal?         @map("ndis_price_cap") @db.Decimal(10, 2)

  lineTotal          Decimal          @map("line_total") @db.Decimal(12, 2)
  gstApplicable      Boolean          @default(false) @map("gst_applicable")
  gstAmount          Decimal          @default(0) @map("gst_amount") @db.Decimal(10, 2)

  createdAt          DateTime         @default(now()) @map("created_at")

  @@index([invoiceId])
  @@index([bookingId])
  @@map("invoice_line_items")
}

model Payment {
  id                    String   @id @default(uuid()) @db.Uuid
  invoiceId             String   @map("invoice_id") @db.Uuid
  invoice               Invoice  @relation(fields: [invoiceId], references: [id])

  amount                Decimal  @db.Decimal(12, 2)
  paymentMethod         String   @map("payment_method") @db.VarChar(50)

  stripePaymentIntentId String?  @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeChargeId        String?  @map("stripe_charge_id") @db.VarChar(100)
  bankReference         String?  @map("bank_reference") @db.VarChar(100)

  status                String   @db.VarChar(20)
  failureReason         String?  @map("failure_reason")

  initiatedAt           DateTime @default(now()) @map("initiated_at")
  completedAt           DateTime? @map("completed_at")

  metadata              Json     @default("{}")

  @@index([invoiceId])
  @@index([stripePaymentIntentId])
  @@map("payments")
}

model ProviderPayout {
  id                String   @id @default(uuid()) @db.Uuid
  providerId        String   @map("provider_id") @db.Uuid
  provider          Provider @relation(fields: [providerId], references: [id])

  amount            Decimal  @db.Decimal(12, 2)
  invoiceIds        String[] @map("invoice_ids") @db.Uuid

  stripeTransferId  String?  @map("stripe_transfer_id") @db.VarChar(100)
  stripePayoutId    String?  @map("stripe_payout_id") @db.VarChar(100)

  status            PayoutStatus
  failureReason     String?  @map("failure_reason")

  bankAccountLast4  String?  @map("bank_account_last_4") @db.VarChar(4)

  initiatedAt       DateTime @default(now()) @map("initiated_at")
  completedAt       DateTime? @map("completed_at")

  metadata          Json     @default("{}")

  @@index([providerId])
  @@index([status])
  @@map("provider_payouts")
}

// ============================================
// REVIEWS & DISPUTES
// ============================================

model Review {
  id                 String   @id @default(uuid()) @db.Uuid
  bookingId          String   @unique @map("booking_id") @db.Uuid
  booking            Booking  @relation(fields: [bookingId], references: [id])

  reviewerId         String   @map("reviewer_id") @db.Uuid
  reviewerType       String   @map("reviewer_type") @db.VarChar(20)
  revieweeId         String   @map("reviewee_id") @db.Uuid
  revieweeType       String   @map("reviewee_type") @db.VarChar(20)

  overallRating      Int      @map("overall_rating")

  punctualityRating  Int?     @map("punctuality_rating")
  qualityRating      Int?     @map("quality_rating")
  communicationRating Int?    @map("communication_rating")
  valueRating        Int?     @map("value_rating")

  reviewText         String?  @map("review_text")

  isPublished        Boolean  @default(true) @map("is_published")
  isFlagged          Boolean  @default(false) @map("is_flagged")
  flaggedReason      String?  @map("flagged_reason")
  moderatedAt        DateTime? @map("moderated_at")
  moderatedBy        String?  @map("moderated_by") @db.Uuid

  providerResponse   String?  @map("provider_response")
  providerResponseAt DateTime? @map("provider_response_at")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@index([bookingId])
  @@index([revieweeId, revieweeType])
  @@index([overallRating])
  @@map("reviews")
}

model Dispute {
  id                 String        @id @default(uuid()) @db.Uuid
  disputeNumber      String        @unique @map("dispute_number") @db.VarChar(20)

  bookingId          String        @unique @map("booking_id") @db.Uuid
  booking            Booking       @relation(fields: [bookingId], references: [id])
  invoiceId          String?       @map("invoice_id") @db.Uuid

  raisedById         String        @map("raised_by_id") @db.Uuid
  raisedByRole       String        @map("raised_by_role") @db.VarChar(20)

  againstId          String        @map("against_id") @db.Uuid
  againstRole        String        @map("against_role") @db.VarChar(20)

  disputeType        DisputeType   @map("dispute_type")
  description        String
  desiredResolution  String?       @map("desired_resolution")

  evidenceUrls       String[]      @default([]) @map("evidence_urls")

  status             DisputeStatus @default(open)
  priority           String        @default("normal") @db.VarChar(10)

  resolutionType     String?       @map("resolution_type") @db.VarChar(50)
  resolutionAmount   Decimal?      @map("resolution_amount") @db.Decimal(10, 2)
  resolutionNotes    String?       @map("resolution_notes")
  resolvedAt         DateTime?     @map("resolved_at")
  resolvedBy         String?       @map("resolved_by") @db.Uuid

  assignedTo         String?       @map("assigned_to") @db.Uuid

  responseDueAt      DateTime?     @map("response_due_at")
  resolutionDueAt    DateTime?     @map("resolution_due_at")

  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  messages           DisputeMessage[]

  @@index([disputeNumber])
  @@index([bookingId])
  @@index([status])
  @@index([raisedById])
  @@map("disputes")
}

model DisputeMessage {
  id           String   @id @default(uuid()) @db.Uuid
  disputeId    String   @map("dispute_id") @db.Uuid
  dispute      Dispute  @relation(fields: [disputeId], references: [id])

  senderId     String   @map("sender_id") @db.Uuid
  senderRole   String   @map("sender_role") @db.VarChar(20)

  message      String
  attachments  String[] @default([])

  isInternal   Boolean  @default(false) @map("is_internal")

  createdAt    DateTime @default(now()) @map("created_at")

  @@index([disputeId])
  @@map("dispute_messages")
}

model Incident {
  id                        String           @id @default(uuid()) @db.Uuid
  incidentNumber            String           @unique @map("incident_number") @db.VarChar(20)

  bookingId                 String?          @map("booking_id") @db.Uuid

  reportedById              String           @map("reported_by_id") @db.Uuid
  reportedByRole            String           @map("reported_by_role") @db.VarChar(20)

  incidentType              IncidentType     @map("incident_type")
  severity                  IncidentSeverity

  incidentDate              DateTime         @map("incident_date") @db.Date
  incidentTime              DateTime?        @map("incident_time") @db.Time()
  location                  String?
  description               String

  participantInvolvedId     String?          @map("participant_involved_id") @db.Uuid
  providerInvolvedId        String?          @map("provider_involved_id") @db.Uuid
  otherPeopleInvolved       Json             @default("[]") @map("other_people_involved")

  immediateActionsTaken     String?          @map("immediate_actions_taken")
  emergencyServicesCalled   Boolean          @default(false) @map("emergency_services_called")

  status                    IncidentStatus   @default(reported)

  requiresCommissionReport  Boolean          @default(false) @map("requires_commission_report")
  reportedToCommissionAt    DateTime?        @map("reported_to_commission_at")
  commissionReference       String?          @map("commission_reference") @db.VarChar(50)

  investigationNotes        String?          @map("investigation_notes")
  outcome                   String?
  correctiveActions         String?          @map("corrective_actions")
  resolvedAt                DateTime?        @map("resolved_at")
  resolvedBy                String?          @map("resolved_by") @db.Uuid

  createdAt                 DateTime         @default(now()) @map("created_at")
  updatedAt                 DateTime         @updatedAt @map("updated_at")

  @@index([incidentNumber])
  @@index([bookingId])
  @@index([status])
  @@index([severity])
  @@map("incidents")
}

// ============================================
// SYSTEM TABLES
// ============================================

model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid

  userId       String?  @map("user_id") @db.Uuid
  user         User?    @relation(fields: [userId], references: [id])
  userEmail    String?  @map("user_email") @db.VarChar(255)
  userRole     String?  @map("user_role") @db.VarChar(20)
  ipAddress    String?  @map("ip_address") @db.Inet
  userAgent    String?  @map("user_agent")

  action       String   @db.VarChar(50)
  entityType   String   @map("entity_type") @db.VarChar(50)
  entityId     String?  @map("entity_id") @db.Uuid

  oldValues    Json?    @map("old_values")
  newValues    Json?    @map("new_values")

  description  String?
  requestId    String?  @map("request_id") @db.Uuid

  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  user         User      @relation(fields: [userId], references: [id])

  type         String    @db.VarChar(50)
  title        String    @db.VarChar(255)
  body         String

  actionUrl    String?   @map("action_url") @db.VarChar(500)
  actionData   Json      @default("{}") @map("action_data")

  entityType   String?   @map("entity_type") @db.VarChar(50)
  entityId     String?   @map("entity_id") @db.Uuid

  channels     String[]  @default(["in_app"])
  emailSentAt  DateTime? @map("email_sent_at")
  smsSentAt    DateTime? @map("sms_sent_at")
  pushSentAt   DateTime? @map("push_sent_at")

  readAt       DateTime? @map("read_at")

  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([userId, readAt])
  @@index([type])
  @@map("notifications")
}

model Conversation {
  id                  String    @id @default(uuid()) @db.Uuid
  participantIds      String[]  @map("participant_ids") @db.Uuid

  bookingId           String?   @map("booking_id") @db.Uuid

  lastMessageAt       DateTime? @map("last_message_at")
  lastMessagePreview  String?   @map("last_message_preview") @db.VarChar(255)

  createdAt           DateTime  @default(now()) @map("created_at")

  messages            Message[]

  @@index([bookingId])
  @@map("conversations")
}

model Message {
  id              String       @id @default(uuid()) @db.Uuid
  conversationId  String       @map("conversation_id") @db.Uuid
  conversation    Conversation @relation(fields: [conversationId], references: [id])

  senderId        String       @map("sender_id") @db.Uuid
  sender          User         @relation("SentMessages", fields: [senderId], references: [id])

  content         String
  attachments     Json         @default("[]")

  readBy          Json         @default("{}") @map("read_by")

  createdAt       DateTime     @default(now()) @map("created_at")

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

model SystemSetting {
  key         String   @id @db.VarChar(100)
  value       Json
  description String?
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy   String?  @map("updated_by") @db.Uuid

  @@map("system_settings")
}

model FeatureFlag {
  id                String   @id @default(uuid()) @db.Uuid
  key               String   @unique @db.VarChar(100)
  name              String   @db.VarChar(255)
  description       String?

  isEnabled         Boolean  @default(false) @map("is_enabled")
  enabledForUsers   String[] @default([]) @map("enabled_for_users") @db.Uuid
  enabledForRoles   String[] @default([]) @map("enabled_for_roles")
  enabledForStates  String[] @default([]) @map("enabled_for_states")
  percentageRollout Int      @default(0) @map("percentage_rollout")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("feature_flags")
}

model ApiKey {
  id                 String    @id @default(uuid()) @db.Uuid
  name               String    @db.VarChar(255)
  keyHash            String    @map("key_hash") @db.VarChar(255)
  keyPrefix          String    @map("key_prefix") @db.VarChar(10)

  userId             String?   @map("user_id") @db.Uuid
  organisationName   String?   @map("organisation_name") @db.VarChar(255)

  scopes             String[]  @default([])

  rateLimitPerMinute Int       @default(60) @map("rate_limit_per_minute")
  rateLimitPerDay    Int       @default(10000) @map("rate_limit_per_day")

  isActive           Boolean   @default(true) @map("is_active")
  lastUsedAt         DateTime? @map("last_used_at")
  expiresAt          DateTime? @map("expires_at")

  createdAt          DateTime  @default(now()) @map("created_at")

  webhookSubscriptions WebhookSubscription[]

  @@index([keyPrefix])
  @@index([userId])
  @@map("api_keys")
}

model WebhookSubscription {
  id              String    @id @default(uuid()) @db.Uuid
  apiKeyId        String    @map("api_key_id") @db.Uuid
  apiKey          ApiKey    @relation(fields: [apiKeyId], references: [id])

  url             String    @db.VarChar(500)
  events          String[]

  secretHash      String    @map("secret_hash") @db.VarChar(255)

  isActive        Boolean   @default(true) @map("is_active")

  lastTriggeredAt DateTime? @map("last_triggered_at")
  failureCount    Int       @default(0) @map("failure_count")

  createdAt       DateTime  @default(now()) @map("created_at")

  deliveries      WebhookDelivery[]

  @@map("webhook_subscriptions")
}

model WebhookDelivery {
  id               String              @id @default(uuid()) @db.Uuid
  subscriptionId   String              @map("subscription_id") @db.Uuid
  subscription     WebhookSubscription @relation(fields: [subscriptionId], references: [id])

  eventType        String              @map("event_type") @db.VarChar(50)
  payload          Json

  status           String              @db.VarChar(20)
  responseStatusCode Int?              @map("response_status_code")
  responseBody     String?             @map("response_body")

  attemptCount     Int                 @default(0) @map("attempt_count")
  nextRetryAt      DateTime?           @map("next_retry_at")

  createdAt        DateTime            @default(now()) @map("created_at")

  @@index([subscriptionId])
  @@index([nextRetryAt])
  @@map("webhook_deliveries")
}
